import glob
import os
from pathlib import Path
import subprocess

def fuzz(malware_dir):
    if not malware_dir:
        print("Please provide a folder to gather the scores from")
    path = "/Users/grbrazil/malwareAnalysis/malwareAnalysis/asm/" + malware_dir
    files = []
    output = "output-{}.txt".format(malware_dir)
    for filename in Path(path).glob('**/*.txt'):
        files.append(filename)
    f = open(output, "w")
    threshold = 0.0
    count = 0
    f.write("Threshold for directory {}".format(malware_dir))
    f.write("\n\n")
    for filenameA in files:
    	for filenameB in files:
            result = subprocess.check_output(["python3","analyze_fuzz.py","--fileA", filenameA,"--fileB", filenameB])
            result = str(result)
            val = result.split(" -> ")
            if "Simularity Score" in val[0]:
                val = val[1]
                score = float(val.split("'")[0])
                f.write("Score from fileA {} and fileB {}\n".format(filenameA, filenameB))
                f.write(str(score))
                f.write("\n\n")
                threshold += score
                count += 1

    threshold = threshold/count
    f.write("Final Count of legitimate scores is {}\n".format(count))
    f.write("Threshold is {}".format(threshold))
    f.write("\n")

fuzz('smarthdd')

#test = "Output From: fileA /Users/grbrazil/malwareAnalysis/malwareAnalysis/asm/CLUSTER912343210/db1ec216be9f890d659497e617fc627d48440ea8.asm.txt fileB /Users/grbrazil/malwareAnalysis/malwareAnalysis/asm/CLUSTER912343210/                          6ff3cbe8e05ffaed06bd705ffc32ab6796d97909.asm.txt \
#\
# b\"'Simularity Score -> 0.0'\n\""
#val = test.split(" -> ")
#val = val.split("'")
#print(f"GRANT {val}")

